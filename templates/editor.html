<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Writer Studio | AryCodes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.tailwindcss.com?plugins=typography,forms"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .editor-area:focus {
            outline: none;
        }

        @media (max-width: 768px) {
            #editor {
                padding: 1rem !important;
            }
        }
    </style>
</head>

<body class="bg-white h-screen flex flex-col font-sans text-slate-800">

    <script>
        // Placeholder variables for standalone functioning
        const BLOG_ID = "{{ blog_id }}";
        const INITIAL_CONTENT = {{ content.content | tojson }};
        const INITIAL_META = {{ meta | tojson }};
    </script>

    <header
        class="h-16 border-b border-slate-200 px-4 md:px-6 flex justify-between items-center bg-white sticky top-0 z-10 shrink-0">

        <div class="flex items-center gap-2 md:gap-4 overflow-hidden">
            <a href="/dashboard" class="p-2 hover:bg-slate-100 rounded-full transition shrink-0">
                <i data-lucide="arrow-left" class="w-5 h-5 text-slate-500"></i>
            </a>
            <div class="overflow-hidden">
                <h1 class="font-bold text-base md:text-lg leading-tight truncate max-w-[150px] md:max-w-[300px]"
                    id="headerTitle">
                    {{ meta.title }}
                </h1>
                <div class="flex items-center gap-2 text-xs">
                    <span id="statusIndicator" class="flex h-2 w-2 rounded-full bg-yellow-500 shrink-0"></span>
                    <span id="statusText" class="text-slate-500 font-medium uppercase tracking-wider truncate">
                        {{ meta.status|default('draft') }}
                    </span>
                    <span id="saveStatus" class="text-slate-400 pl-2 hidden italic truncate">Saved</span>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-2 md:gap-4">

            <div class="hidden md:flex items-center gap-2 border-r border-slate-200 pr-4 mr-1">
                <span class="text-xs font-semibold text-slate-500">Auto-save</span>
                <button id="autoSaveBtn" onclick="toggleAutoSave()"
                    class="w-10 h-5 bg-slate-200 rounded-full relative transition-colors duration-200 focus:outline-none ring-offset-2 focus:ring-2 ring-indigo-500">
                    <div id="autoSaveKnob"
                        class="absolute left-1 top-1 w-3 h-3 bg-white rounded-full shadow-sm transition-transform duration-200">
                    </div>
                </button>
            </div>

            <button id="manualSaveBtn" onclick="manualSave()"
                class="group flex items-center gap-2 px-2 md:px-3 py-1.5 text-sm font-medium text-slate-600 hover:bg-slate-100 hover:text-indigo-600 rounded-md transition border border-slate-200">
                <i data-lucide="save" class="w-4 h-4 text-slate-400 group-hover:text-indigo-600 transition"></i>
                <span class="hidden md:inline">Save</span>
            </button>

            <button onclick="toggleSettingsModal()" class="p-2 text-slate-600 hover:bg-slate-100 rounded-md transition">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>

            <button id="pubBtn" onclick="togglePublishStatus()"
                class="flex items-center gap-2 px-3 md:px-4 py-2 text-sm font-semibold text-white rounded-md transition shadow-sm bg-slate-900 hover:bg-slate-800">
                <span id="pubBtnText" class="hidden md:inline">Publish</span>
                <i data-lucide="send" class="w-3 h-3"></i>
            </button>
        </div>
    </header>

    <main class="flex flex-1 overflow-hidden relative">
        <div id="editorPane" class="w-full md:w-1/2 flex flex-col border-r border-slate-200 bg-white h-full">

            <div
                class="flex items-center gap-1 p-2 border-b border-slate-100 bg-slate-50 overflow-x-auto shrink-0 no-scrollbar">
                <button onclick="insertTemplate('bold')" title="Bold (Ctrl+B)"
                    class="p-1.5 text-slate-600 hover:bg-slate-200 hover:text-indigo-600 rounded transition">
                    <i data-lucide="bold" class="w-4 h-4"></i>
                </button>
                <button onclick="insertTemplate('italic')" title="Italic (Ctrl+I)"
                    class="p-1.5 text-slate-600 hover:bg-slate-200 hover:text-indigo-600 rounded transition">
                    <i data-lucide="italic" class="w-4 h-4"></i>
                </button>
                <button onclick="insertTemplate('heading')" title="Heading"
                    class="p-1.5 text-slate-600 hover:bg-slate-200 hover:text-indigo-600 rounded transition">
                    <i data-lucide="heading" class="w-4 h-4"></i>
                </button>
                <button onclick="insertTemplate('quote')" title="Quote"
                    class="p-1.5 text-slate-600 hover:bg-slate-200 hover:text-indigo-600 rounded transition mr-2">
                    <i data-lucide="quote" class="w-4 h-4"></i>
                </button>

                <div class="w-px h-4 bg-slate-300 mx-1"></div>

                <button onclick="insertTemplate('link')" title="Link"
                    class="p-1.5 text-slate-600 hover:bg-slate-200 hover:text-indigo-600 rounded transition">
                    <i data-lucide="link" class="w-4 h-4"></i>
                </button>
                <button onclick="insertTemplate('image')" title="Image"
                    class="p-1.5 text-slate-600 hover:bg-slate-200 hover:text-indigo-600 rounded transition">
                    <i data-lucide="image" class="w-4 h-4"></i>
                </button>
                <button onclick="insertTemplate('code')" title="Code Block"
                    class="p-1.5 text-slate-600 hover:bg-slate-200 hover:text-indigo-600 rounded transition">
                    <i data-lucide="code" class="w-4 h-4"></i>
                </button>
                <button onclick="insertTemplate('table')" title="Table"
                    class="p-1.5 text-slate-600 hover:bg-slate-200 hover:text-indigo-600 rounded transition">
                    <i data-lucide="table" class="w-4 h-4"></i>
                </button>
                <button onclick="insertTemplate('math')" title="Math Equation"
                    class="p-1.5 text-slate-600 hover:bg-slate-200 hover:text-indigo-600 rounded transition">
                    <i data-lucide="sigma" class="w-4 h-4"></i>
                </button>
            </div>
            <textarea id="editor"
                class="w-full h-full p-4 md:p-8 text-base font-mono bg-white resize-none editor-area leading-relaxed text-slate-700 placeholder-slate-300 focus:outline-none"
                placeholder="# Start writing your story here..." spellcheck="false"></textarea>
        </div>

        <div id="previewPane" class="hidden md:block w-full md:w-1/2 h-full overflow-y-auto bg-slate-50/50 p-4 md:p-8">
            <div id="preview"
                class="prose prose-slate prose-lg max-w-none prose-headings:font-bold prose-a:text-blue-600 prose-img:rounded-xl">
            </div>
        </div>

        <button id="mobileViewToggle" onclick="toggleMobileView()"
            class="md:hidden fixed bottom-6 right-6 h-14 w-14 bg-indigo-600 text-white rounded-full shadow-xl flex items-center justify-center z-40 hover:bg-indigo-700 transition-transform active:scale-95">
            <i id="toggleIcon" data-lucide="eye" class="w-6 h-6"></i>
        </button>
    </main>

    <div id="settingsModal"
        class="fixed inset-0 z-50 hidden bg-slate-900/20 backdrop-blur-sm transition-opacity opacity-0">
        <div class="absolute right-0 top-0 h-full w-full md:w-[400px] bg-white shadow-2xl p-6 transform transition-transform translate-x-full duration-300"
            id="settingsPanel">

            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-slate-800">Post Settings</h2>
                <button onclick="toggleSettingsModal()"
                    class="text-slate-400 hover:text-slate-600 bg-slate-50 p-1 rounded-full">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="space-y-5 overflow-y-auto max-h-[calc(100vh-100px)]">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Title</label>
                    <input id="metaTitle" type="text"
                        class="w-full border-slate-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                        value="{{ meta.title }}">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Slug URL</label>
                    <input id="metaSlug" type="text"
                        class="w-full border-slate-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm text-slate-500"
                        value="{{ meta.slug }}">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description (SEO)</label>
                    <textarea id="metaDesc" rows="3"
                        class="w-full border-slate-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">{{ meta.description }}</textarea>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Thumbnail URL</label>
                    <input id="metaThumb" type="text"
                        class="w-full border-slate-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                        value="{{ meta.thumbnail_url }}">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Authon Name</label>
                    <input id="metaAuth" type="text"
                        class="w-full border-slate-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                        value="{{ meta.author.name }}">
                </div>

                <div class="pt-4 border-t border-slate-100 pb-10">
                    <button onclick="saveSettings()"
                        class="w-full py-2 bg-indigo-600 text-white rounded-md font-medium hover:bg-indigo-700 transition shadow-sm">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast"
        class="fixed bottom-24 md:bottom-6 right-6 px-4 py-3 rounded-lg shadow-lg bg-slate-800 text-white text-sm font-medium transform translate-y-48 transition-transform duration-300 flex items-center gap-2 z-50">
        <i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i>
        <span id="toastMsg">Action Successful</span>
    </div>

    <script>
        lucide.createIcons();
        const editor = document.getElementById("editor");
        const preview = document.getElementById("preview");

        editor.value = INITIAL_CONTENT || "";
        let currentStatus = INITIAL_META.status || "draft";

        let isAutoSaveEnabled = false;

        updateUIForStatus(currentStatus);
        updateAutoSaveUI();

        function render() {
            preview.innerHTML = marked.parse(editor.value);
            document.querySelectorAll("pre code").forEach(block => hljs.highlightElement(block));
            MathJax.typesetPromise();
        }
        render();

        let saveTimer;
        function handleInput() {
            render(); 

            const statusEl = document.getElementById("saveStatus");
            statusEl.classList.remove("hidden");

            if (isAutoSaveEnabled) {
                statusEl.innerText = "Saving...";
                statusEl.className = "text-slate-400 pl-2 italic";

                clearTimeout(saveTimer);
                saveTimer = setTimeout(autoSaveTrigger, 1500); // 1.5s debounce
            } else {
                statusEl.innerText = "Unsaved changes";
                statusEl.className = "text-orange-500 pl-2 font-medium text-[11px] truncate";
            }
        }

        editor.addEventListener("input", handleInput);

        function insertTemplate(type) {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            const selectedText = text.substring(start, end);

            let prefix = "";
            let suffix = "";
            let defaultText = "";

            switch (type) {
                case 'bold':
                    prefix = "**";
                    suffix = "**";
                    defaultText = "Bold Text";
                    break;
                case 'italic':
                    prefix = "_";
                    suffix = "_";
                    defaultText = "Italic Text";
                    break;
                case 'heading':
                    prefix = "## ";
                    suffix = "";
                    defaultText = "Heading";
                    break;
                case 'quote':
                    prefix = "> ";
                    suffix = "";
                    defaultText = "Quote";
                    break;
                case 'link':
                    prefix = "[";
                    suffix = "](url)";
                    defaultText = "Link text";
                    break;
                case 'image':
                    prefix = "![";
                    suffix = "](image_url)";
                    defaultText = "Alt text";
                    break;
                case 'code':
                    prefix = "```javascript\n";
                    suffix = "\n```";
                    defaultText = "// Your code here";
                    break;
                case 'table':
                    prefix = "\n| Header 1 | Header 2 |\n| -------- | -------- |\n| ";
                    suffix = " | Cell 2   |\n| Cell 3   | Cell 4   |\n";
                    defaultText = "Cell 1";
                    break;
                case 'math':
                    prefix = "\n$$ ";
                    suffix = "$$ \n";
                    defaultText = "f(x)=sin(x)";
                    break;
            }

            const insertion = selectedText.length > 0 ? selectedText : defaultText;
            const replacement = prefix + insertion + suffix;

            // Insert into editor
            editor.setRangeText(replacement, start, end, 'select');

            // Currently 'select' highlights the inserted block so the user can see it immediately

            // Trigger render and save logic
            handleInput();
            editor.focus();
        }


        // --- 4. Save Functions ---

        // NEW: Ctrl+S and Ctrl+B/I Listeners
        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 's') {
                    e.preventDefault();
                    manualSave();
                }
                // Shortcuts for bold/italic if editor is focused
                if (document.activeElement === editor) {
                    if (e.key === 'b') { e.preventDefault(); insertTemplate('bold'); }
                    if (e.key === 'i') { e.preventDefault(); insertTemplate('italic'); }
                }
            }
        });

        async function autoSaveTrigger() {
            if (!isAutoSaveEnabled) return;
            await saveContentToBackend(true);
        }

        async function manualSave() {
            const btnIcon = document.querySelector("#manualSaveBtn svg");
            if (btnIcon) btnIcon.classList.add("animate-spin");

            await saveContentToBackend(false);

            if (btnIcon) btnIcon.classList.remove("animate-spin");
            showToast("Content saved manually");
        }

        async function saveContentToBackend(silent) {
            try {
                await fetch(`/api/blog/save-content/${BLOG_ID}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ content: editor.value })
                });

                const statusEl = document.getElementById("saveStatus");
                statusEl.innerText = "All changes saved";
                statusEl.className = "text-green-600 pl-2 text-[11px] font-medium truncate";

                setTimeout(() => {
                    if (statusEl.innerText === "All changes saved") {
                        statusEl.classList.add("hidden");
                    }
                }, 3000);

            } catch (e) {
                console.error("Save failed", e);
                document.getElementById("saveStatus").innerText = "Error saving";
                document.getElementById("saveStatus").className = "text-red-500 pl-2 font-bold truncate";
            }
        }

        // --- 5. Auto Save Toggle Logic ---
        function toggleAutoSave() {
            isAutoSaveEnabled = !isAutoSaveEnabled;
            updateAutoSaveUI();

            if (isAutoSaveEnabled) {
                document.getElementById("saveStatus").innerText = "Saving...";
                saveContentToBackend(true);
                showToast("Auto-save enabled");
            } else {
                showToast("Auto-save disabled");
            }
        }

        function updateAutoSaveUI() {
            const btn = document.getElementById("autoSaveBtn");
            const knob = document.getElementById("autoSaveKnob");

            if (isAutoSaveEnabled) {
                btn.classList.remove("bg-slate-200");
                btn.classList.add("bg-green-500");
                knob.classList.add("translate-x-5");
            } else {
                btn.classList.add("bg-slate-200");
                btn.classList.remove("bg-green-500");
                knob.classList.remove("translate-x-5");
            }
        }

        // --- 6. Settings Modal ---
        const modal = document.getElementById("settingsModal");
        const panel = document.getElementById("settingsPanel");

        function toggleSettingsModal() {
            const isHidden = modal.classList.contains("hidden");
            if (isHidden) {
                modal.classList.remove("hidden");
                setTimeout(() => {
                    modal.classList.remove("opacity-0");
                    panel.classList.remove("translate-x-full");
                }, 10);
            } else {
                modal.classList.add("opacity-0");
                panel.classList.add("translate-x-full");
                setTimeout(() => modal.classList.add("hidden"), 300);
            }
        }

        async function saveSettings() {
            const payload = {
                title: document.getElementById("metaTitle").value,
                slug: document.getElementById("metaSlug").value,
                description: document.getElementById("metaDesc").value,
                thumbnail: document.getElementById("metaThumb").value,
                author: document.getElementById("metaAuth").value
            };

            const res = await fetch(`/api/blog/update-meta/${BLOG_ID}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                document.getElementById("headerTitle").innerText = payload.title;
                toggleSettingsModal();
                showToast("Settings updated successfully");
            }
        }

        // --- 7. Publish / Unpublish ---
        async function togglePublishStatus() {
            const newStatus = currentStatus === "published" ? "draft" : "published";

            const res = await fetch(`/api/blog/status/${BLOG_ID}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: newStatus })
            });

            if (res.ok) {
                currentStatus = newStatus;
                updateUIForStatus(newStatus);
                showToast(newStatus === "published" ? "Blog is now Live!" : "Reverted to Draft");
            }
        }

        function updateUIForStatus(status) {
            const indicator = document.getElementById("statusIndicator");
            const text = document.getElementById("statusText");
            const btn = document.getElementById("pubBtn");
            const btnText = document.getElementById("pubBtnText");

            if (status === "published") {
                indicator.className = "flex h-2 w-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)] shrink-0";
                text.innerText = "Published";
                text.className = "text-green-600 font-bold uppercase tracking-wider text-[10px] truncate";

                btnText.innerText = "Unpublish";
                btn.className = "flex items-center gap-2 px-3 md:px-4 py-2 text-sm font-semibold text-red-600 bg-red-50 border border-red-200 rounded-md transition hover:bg-red-100";
            } else {
                indicator.className = "flex h-2 w-2 rounded-full bg-slate-300 shrink-0";
                text.innerText = "Draft";
                text.className = "text-slate-400 font-bold uppercase tracking-wider text-[10px] truncate";

                btnText.innerText = "Publish";
                btn.className = "flex items-center gap-2 px-3 md:px-4 py-2 text-sm font-semibold text-white bg-slate-900 rounded-md transition hover:bg-slate-700 shadow-md";
            }
        }

        // --- 8. Mobile View Toggle Logic ---
        let isMobilePreviewActive = false;

        function toggleMobileView() {
            const editorPane = document.getElementById("editorPane");
            const previewPane = document.getElementById("previewPane");
            const icon = document.getElementById("toggleIcon");

            isMobilePreviewActive = !isMobilePreviewActive;

            // Simple logic: Toggle hidden classes
            // Note: md:block / md:w-1/2 ensures desktop stays split screen
            if (isMobilePreviewActive) {
                editorPane.classList.add("hidden");
                previewPane.classList.remove("hidden");
                // Switch icon to Edit Pen
                icon.setAttribute("data-lucide", "pen-line");
            } else {
                editorPane.classList.remove("hidden");
                previewPane.classList.add("hidden");
                // Switch icon to Eye
                icon.setAttribute("data-lucide", "eye");
            }
            lucide.createIcons();
        }

        // Ensure state resets on resize to desktop
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                // Force reset to desktop split view
                document.getElementById("editorPane").classList.remove("hidden");
                document.getElementById("previewPane").classList.remove("hidden");
                // Reset mobile state for next time
                isMobilePreviewActive = false;
                document.getElementById("toggleIcon").setAttribute("data-lucide", "eye");
                lucide.createIcons();
            } else {
                // If resized down to mobile, apply current state
                const editorPane = document.getElementById("editorPane");
                const previewPane = document.getElementById("previewPane");
                if (isMobilePreviewActive) {
                    editorPane.classList.add("hidden");
                    previewPane.classList.remove("hidden");
                } else {
                    editorPane.classList.remove("hidden");
                    previewPane.classList.add("hidden");
                }
            }
        });

        // --- 9. Utilities ---
        function showToast(message) {
            const toast = document.getElementById("toast");
            document.getElementById("toastMsg").innerText = message;
            toast.classList.remove("translate-y-48");
            setTimeout(() => toast.classList.add("translate-y-48"), 3000);
        }
    </script>

</body>

</html>